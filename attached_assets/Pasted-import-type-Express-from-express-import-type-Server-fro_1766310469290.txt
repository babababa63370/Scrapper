import type { Express } from "express";
import type { Server } from "http";
import { storage } from "./storage";
import { api } from "@shared/routes";
import fs from "fs";
import path from "path";
import { InsertScrapedPage } from "@shared/schema";
import multer from "multer";

export async function registerRoutes(
  httpServer: Server,
  app: Express
): Promise<Server> {
  
  const upload = multer({ storage: multer.memoryStorage() });

  // Routes
  app.get(api.pages.list.path, async (req, res) => {
    const pages = await storage.getPages();
    res.json(pages);
  });

  app.get(api.pages.get.path, async (req, res) => {
    const page = await storage.getPage(Number(req.params.id));
    if (!page) {
      return res.status(404).json({ message: 'Page not found' });
    }
    res.json(page);
  });

  app.delete(api.pages.delete.path, async (req, res) => {
    const page = await storage.getPage(Number(req.params.id));
    if (!page) {
      return res.status(404).json({ message: 'Page not found' });
    }
    await storage.deletePage(Number(req.params.id));
    res.status(204).send();
  });

  app.post(api.pages.upload.path, upload.single('file'), async (req, res) => {
    try {
      if (!req.file) {
        return res.status(400).json({ message: 'No file provided' });
      }

      const jsonData = JSON.parse(req.file.buffer.toString('utf-8'));
      
      if (!Array.isArray(jsonData)) {
        return res.status(400).json({ message: 'JSON must be an array of pages' });
      }

      let count = 0;
      for (const item of jsonData) {
        try {
          const page: InsertScrapedPage = {
            originalId: item.id,
            url: item.url,
            title: item.title,
            htmlContent: item.htmlContent,
            cssContent: item.cssContent || '',
            baseUrl: item.baseUrl,
          };
          await storage.createPage(page);
          count++;
        } catch (error) {
          console.error('Error importing page:', error);
        }
      }

      res.status(201).json({ count, message: `Imported ${count} pages` });
    } catch (error) {
      res.status(400).json({ message: 'Invalid JSON file' });
    }
  });

  // Seed data from attached file if database is empty
  seedDatabase().catch(console.error);

  return httpServer;
}

async function seedDatabase() {
  const existingPages = await storage.getPages();
  if (existingPages.length > 0) return;

  const seedFilePath = path.join(process.cwd(), "attached_assets", "scraped-pages-2025-12-20(2)_1766246940315.json");
  
  if (fs.existsSync(seedFilePath)) {
    try {
      const fileContent = fs.readFileSync(seedFilePath, "utf-8");
      const data = JSON.parse(fileContent);
      
      console.log(`Seeding ${data.length} pages...`);
      
      for (const item of data) {
        const page: InsertScrapedPage = {
            originalId: item.id,
            url: item.url,
            title: item.title,
            htmlContent: item.htmlContent,
            cssContent: item.cssContent,
            baseUrl: item.baseUrl,
            // createdAt will be handled by default or we can parse it if needed, 
            // but schema has defaultNow(). Let's stick to defaultNow for simplicity 
            // or we could parse item.createdAt.
        };
        await storage.createPage(page);
      }
      console.log("Seeding complete.");
    } catch (error) {
      console.error("Error seeding database:", error);
    }
  } else {
    console.log("Seed file not found:", seedFilePath);
  }
}